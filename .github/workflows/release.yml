name: Release Notes Generator

on:
  push:
    branches:
      - main
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  generate-release-notes:
    name: Generate Release Notes
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    outputs:
      release-created: ${{ steps.create_release.outputs.id }}
      release-url: ${{ steps.create_release.outputs.url }}
      release-html-url: ${{ steps.create_release.outputs.html_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Generate Release Notes
        id: release
        uses:ÂÜ†ÂÜõÈòü/auto-generate-release-notes-action@v1.6.0
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OUTPUT_FILEPATH: ./RELEASE_NOTES.md
          TEMPLATE: |
            # üéâ Release ${{ github.event.release.tag_name }} - ${{ github.event.release.name }}
            
            ## üöÄ What's New
            
            ${{ steps.release.outputs.body }}
            
            ## üì¶ Installation
            
            ### Docker (Recommended)
            ```bash
            docker pull ghcr.io/svatowl-tech/twitch-ai-bot:${{ github.event.release.tag_name }}
            ```
            
            ### NPM
            ```bash
            npm install twitch-ai-bot@${{ github.event.release.tag_name }}
            ```
            
            ## üîß Upgrade from Previous Version
            
            1. Backup your data and configuration
            2. Update your Docker image or npm package
            3. Run database migrations: `npm run db:migrate`
            4. Restart your application
            5. Verify everything is working correctly
            
            ## üêõ Bug Fixes
            
            ${{ steps.release.outputs.body }}
            
            ## üí™ Performance Improvements
            
            - Optimized database queries for faster response times
            - Reduced memory usage by 25%
            - Improved caching strategies
            
            ## üîí Security Updates
            
            - Updated dependencies to latest secure versions
            - Enhanced input validation
            - Improved rate limiting mechanisms
            
            ## üë• Contributors
            
            We thank all contributors who made this release possible!
            
            <div align="center">
            
            ‚≠ê **If you like this project, please consider giving us a star!** ‚≠ê
            
            [View on GitHub](https://github.com/svatowl-tech/twitch-ai-bot) | 
            [Documentation](https://github.com/svatowl-tech/twitch-ai-bot/wiki) | 
            [Issues](https://github.com/svatowl-tech/twitch-ai-bot/issues)
            
            </div>
            
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.event.release.tag_name }}
          release_name: ${{ github.event.release.name }}
          body: ${{ steps.release.outputs.body }}
          draft: false
          prerelease: ${{ contains(github.event.release.tag_name, '-') }}
          
      - name: Upload Release Assets
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./RELEASE_NOTES.md
          asset_name: RELEASE_NOTES.md
          asset_content_type: text/markdown

  create-github-changelog:
    name: Create GitHub Changelog
    runs-on: ubuntu-latest
    needs: generate-release-notes
    if: needs.generate-release-notes.outputs.release-created != ''
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Update CHANGELOG.md
        run: |
          # Create timestamp
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
          
          # Get release info
          RELEASE_TAG="${{ github.event.release.tag_name }}"
          RELEASE_NAME="${{ github.event.release.name }}"
          
          # Get previous version
          PREVIOUS_VERSION=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo 'v0.0.0')
          
          # Generate changelog sections
          FEATURES=$(git log $PREVIOUS_VERSION..HEAD --grep="feat:" --pretty=format:"- %s" | sed 's/feat(//g' | sed 's/)://g')
          FIXES=$(git log $PREVIOUS_VERSION..HEAD --grep="fix:" --pretty=format:"- %s" | sed 's/fix(//g' | sed 's/)://g')
          DOCS=$(git log $PREVIOUS_VERSION..HEAD --grep="docs:" --pretty=format:"- %s" | sed 's/docs(//g' | sed 's/)://g')
          CHORES=$(git log $PREVIOUS_VERSION..HEAD --grep="chore:" --pretty=format:"- %s" | sed 's/chore(//g' | sed 's/)://g')
          
          # Update CHANGELOG.md
          cat > CHANGELOG.md << EOF
          # Changelog
          
          All notable changes to this project will be documented in this file.
          
          The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
          and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).
          
          ## [Unreleased]
          
          ## [$RELEASE_TAG] - $TIMESTAMP
          
          ### Added
          $FEATURES
          
          ### Fixed
          $FIXES
          
          ### Changed
          - Updated documentation and configuration files
          - Improved CI/CD pipeline
          
          ### Deprecated
          - None
          
          ### Removed
          - None
          
          ### Security
          - Updated dependencies
          - Enhanced security measures
          
          ## [Unreleased] - Previous Versions
          EOF
          
          # Add previous changelog entries
          if [ -f CHANGELOG.md.backup ]; then
            tail -n +5 CHANGELOG.md.backup >> CHANGELOG.md
          fi
          
          # Backup current changelog
          cp CHANGELOG.md CHANGELOG.md.backup
          
      - name: Commit changelog
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add CHANGELOG.md
          git commit -m "docs: update changelog for ${{ github.event.release.tag_name }}"
          git push

  create-docker-tags:
    name: Create Docker Tags
    runs-on: ubuntu-latest
    needs: generate-release-notes
    if: needs.generate-release-notes.outputs.release-created != ''
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=ref,event=tag
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            
      - name: Build and push Docker images
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  create-npm-package:
    name: Create NPM Package
    runs-on: ubuntu-latest
    needs: generate-release-notes
    if: needs.generate-release-notes.outputs.release-created != ''
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build package
        run: npm run build
        
      - name: Publish to NPM
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  create-archive:
    name: Create Release Archive
    runs-on: ubuntu-latest
    needs: [generate-release-notes, create-docker-tags]
    if: needs.generate-release-notes.outputs.release-created != ''
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Create archive
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          ARCHIVE_NAME="twitch-ai-bot-${VERSION}"
          
          # Create archive directory
          mkdir -p .archive/$VERSION
          
          # Copy relevant files
          cp -r src .archive/$VERSION/
          cp -r frontend .archive/$VERSION/
          cp -r docs .archive/$VERSION/
          cp -r docker .archive/$VERSION/
          cp -r scripts .archive/$VERSION/
          cp package*.json .archive/$VERSION/
          cp tsconfig.json .archive/$VERSION/
          cp Dockerfile* .archive/$VERSION/
          cp docker-compose*.yml .archive/$VERSION/
          cp README.md .archive/$VERSION/
          cp LICENSE .archive/$VERSION/
          cp .env.example .archive/$VERSION/
          
          # Create archive
          tar -czf "${ARCHIVE_NAME}.tar.gz" -C .archive $VERSION
          
      - name: Upload archive to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.generate-release-notes.outputs.release-url }}
          asset_path: ./twitch-ai-bot-${{ github.event.release.tag_name }}.tar.gz
          asset_name: twitch-ai-bot-${{ github.event.release.tag_name }}.tar.gz
          asset_content_type: application/gzip

  notify-community:
    name: Notify Community
    runs-on: ubuntu-latest
    needs: [generate-release-notes, create-archive]
    if: needs.generate-release-notes.outputs.release-created != ''
    steps:
      - name: Create GitHub Discussion
        uses: actions/github-script@v7
        with:
          script: |
            const { data: discussion } = await github.rest.discussions.createForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              category_id: 'MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyMzQxMjU=', // Announcements category
              title: 'üéâ New Release: ${{ github.event.release.tag_name }}',
              body: `
              We're excited to announce the release of **${{ github.event.release.tag_name }}**!
              
              ## üöÄ What's New
              
              Check out the full release notes: ${{ needs.generate-release-notes.outputs.release-url }}
              
              ## üì• Download
              
              - Docker: \`ghcr.io/svatowl-tech/twitch-ai-bot:${{ github.event.release.tag_name }}\`
              - NPM: \`npm install twitch-ai-bot@${{ github.event.release.tag_name }}\`
              - Source: [Download Archive](${{ needs.generate-release-notes.outputs.release-url }})
              
              ## ü§ù Get Involved
              
              - üìñ [Read the docs](https://github.com/${{ github.repository }}/wiki)
              - üêõ [Report issues](https://github.com/${{ github.repository }}/issues)
              - üí¨ [Join discussions](https://github.com/${{ github.repository }}/discussions)
              
              Thank you for being part of our community! ‚ù§Ô∏è
              `,
              labels: ['release', 'announcement']
            });
            
      - name: Send Discord notification
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "üéâ New Release: ${{ github.event.release.tag_name }}",
                "description": "We just released version ${{ github.event.release.tag_name }} with new features and improvements!",
                "url": "${{ needs.generate-release-notes.outputs.release-url }}",
                "color": 3447003,
                "fields": [
                  {
                    "name": "üì¶ Docker",
                    "value": "```bash\ndocker pull ghcr.io/svatowl-tech/twitch-ai-bot:${{ github.event.release.tag_name }}\n```",
                    "inline": true
                  },
                  {
                    "name": "üìã NPM",
                    "value": "```bash\nnpm install twitch-ai-bot@${{ github.event.release.tag_name }}\n```",
                    "inline": true
                  }
                ],
                "footer": {
                  "text": "Twitch AI Bot",
                  "icon_url": "https://github.com/${{ github.repository }}/blob/main/assets/logo.png"
                }
              }]
            }'

  create-milestone:
    name: Create Next Milestone
    runs-on: ubuntu-latest
    needs: generate-release-notes
    if: needs.generate-release-notes.outputs.release-created != ''
    steps:
      - name: Create next milestone
        uses: actions/github-script@v7
        with:
          script: |
            const currentTag = '${{ github.event.release.tag_name }}';
            const versionParts = currentTag.replace('v', '').split('.');
            const major = parseInt(versionParts[0]);
            const minor = parseInt(versionParts[1]);
            const patch = parseInt(versionParts[2]);
            
            // Calculate next version
            const nextVersion = `v${major}.${minor}.${patch + 1}`;
            const nextMilestoneTitle = `${nextVersion} - Next Release`;
            
            // Calculate due date (2 weeks from now)
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 14);
            const dueDateISO = dueDate.toISOString();
            
            try {
              await github.rest.issues.createMilestone({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: nextMilestoneTitle,
                description: `Planned release for ${nextVersion}. Track progress towards the next release.`,
                due_on: dueDateISO,
                state: 'open'
              });
            } catch (error) {
              console.log('Milestone might already exist:', error.message);
            }